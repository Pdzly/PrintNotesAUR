name: Update AUR Package

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and run Arch Linux container
        uses: addnab/docker-run-action@v3
        with:
          image: archlinux:latest
          options: -v ${{ github.workspace }}:/workspace -w /workspace
          run: |
            # Update system and install required packages
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed base-devel git bash openssh
            
            # Set up SSH for AUR deployment
            mkdir -p ~/.ssh
            echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
            chmod 700 ~/.ssh
            
            # Make script executable
            chmod +x update-pkgbuild.sh
            
            # Run the update script
            ./update-pkgbuild.sh
            
            # Check if script succeeded (exit code 0 means changes were made)
            if [ $? -eq 0 ]; then
              echo "deployment_needed=true" >> $GITHUB_ENV
            else
              echo "deployment_needed=false" >> $GITHUB_ENV
            fi

      - name: Deploy to AUR (if needed)
        if: env.deployment_needed == 'true'
        run: |
          # Clone AUR repo using SSH
          git clone ssh://aur@aur.archlinux.org/printnotes.git aur-printnotes
          
          # Copy updated files to AUR repo
          cp PKGBUILD .SRCINFO aur-printnotes/
          
          # Commit and push changes
          cd aur-printnotes
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Update package to latest version"
          git push origin master