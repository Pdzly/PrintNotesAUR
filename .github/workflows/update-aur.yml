name: Update AUR Package

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and run Arch Linux container
        uses: addnab/docker-run-action@v3
        with:
          image: archlinux:latest
          options: -v ${{ github.workspace }}:/workspace -w /workspace
          run: |
            # Update system and install required packages
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed base-devel git bash openssh sudo
            
            # Clone yay repository
            git clone https://aur.archlinux.org/yay.git
            cd yay
            
            # Build and install yay
            makepkg -si
            
            yay -S flutter
            
            # Set up SSH for AUR deployment
            mkdir -p ~/.ssh
            echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
            chmod 700 ~/.ssh
            
            # Create a non-root user for building
            useradd -m -s /bin/bash builder
            passwd -d builder
            
            # Grant sudo access without password for makepkg
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            
            ls
            
            # Make script executable
            chmod +x update-pkgbuild.sh
            
            cp update-pkgbuild.sh /home/builder/
            cp PKGBUILD /home/builder/

            # Run the update script as non-root user
            su - builder -c "./update-pkgbuild.sh"
            
            # Check if script succeeded (exit code 0 means changes were made)
            if [ $? -eq 0 ]; then
              # Commit and push changes
              # Clone AUR repo using SSH
              git clone ssh://aur@aur.archlinux.org/printnotes.git aur-printnotes
            
              # Copy updated files to AUR repo
              cp /home/builder/PKGBUILD /home/builder/.SRCINFO aur-printnotes/
              cd aur-printnotes
              git config --global user.name 'Rooki'
              git config --global user.email 'aur@rooki.xyz'
              git add .
              git commit -m "Update package to latest version"
              git push origin master
            else
              echo "No changes detected, skipping deployment" 
              exit 1
            fi
